<!DOCTYPE html>
<html lang=en>
<head>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><!-- so meta -->
    <meta name="google-site-verification" content="UNYt0mwCryY0AxQmScjINFHeN-6DM9BpsNSRyHNojaY" />
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="TL;DR: I built a synthesizer for the web using C++ and WebAssembly. This post outlines how I did it. Read on to learn more or check out the project directly: [source] [demo]   Introduction In November">
<meta property="og:type" content="article">
<meta property="og:title" content="Building a web-ready synthesizer with WASM and C++">
<meta property="og:url" content="https://timdaub.github.io/2020/02/11/wasm-synth/index.html">
<meta property="og:site_name" content="Tim&#39;s website">
<meta property="og:description" content="TL;DR: I built a synthesizer for the web using C++ and WebAssembly. This post outlines how I did it. Read on to learn more or check out the project directly: [source] [demo]   Introduction In November">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://timdaub.github.io/assets/images/wasm-synth.png">
<meta property="og:image" content="https://timdaub.github.io/assets/images/nyquist.png">
<meta property="og:image" content="https://timdaub.github.io/assets/images/frames.png">
<meta property="og:image" content="https://timdaub.github.io/assets/images/ring-buffer.gif">
<meta property="og:image" content="https://timdaub.github.io/assets/images/audioworklet-compatibility.png">
<meta property="og:image" content="https://timdaub.github.io/assets/images/chunked-sinus-inverted.png">
<meta property="og:image" content="https://timdaub.github.io/assets/images/live-operator.png">
<meta property="og:image" content="https://media.giphy.com/media/trWQWvzDRmFCE/giphy.gif">
<meta property="og:image" content="https://timdaub.github.io/assets/images/adsr.png">
<meta property="og:image" content="https://timdaub.github.io/assets/images/react-envelope-graph.gif">
<meta property="og:image" content="https://timdaub.github.io/assets/images/exponential-adsr.gif">
<meta property="og:image" content="https://timdaub.github.io/assets/images/desmos-adjustable-exp.gif">
<meta property="og:image" content="https://timdaub.github.io/assets/images/import-support.png">
<meta property="article:published_time" content="2020-02-11T15:14:21.379Z">
<meta property="article:modified_time" content="2020-02-11T15:14:21.379Z">
<meta property="article:author" content="Tim DaubenschÃ¼tz">
<meta property="article:tag" content="Music">
<meta property="article:tag" content="Web">
<meta property="article:tag" content="WASM">
<meta property="article:tag" content="WebAssembly">
<meta property="article:tag" content="C++">
<meta property="article:tag" content="Synthesizer">
<meta property="article:tag" content="AudioWorklet">
<meta property="article:tag" content="ESNext">
<meta property="article:tag" content="Math">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://timdaub.github.io/assets/images/wasm-synth.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Building a web-ready synthesizer with WASM and C++</title><meta name="robots" content="noindex">
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 4.2.0"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head>

<body class="max-width mx-auto px3 ltr">
    
      <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/projects/">Projects</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://timdaub.github.io/2020/02/11/wasm-synth/" target="_blank" rel="noopener"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://timdaub.github.io/2020/02/11/wasm-synth/&text=Building a web-ready synthesizer with WASM and C++" target="_blank" rel="noopener"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://timdaub.github.io/2020/02/11/wasm-synth/&title=Building a web-ready synthesizer with WASM and C++" target="_blank" rel="noopener"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://timdaub.github.io/2020/02/11/wasm-synth/&is_video=false&description=Building a web-ready synthesizer with WASM and C++" target="_blank" rel="noopener"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Building a web-ready synthesizer with WASM and C++&body=Check out this article: https://timdaub.github.io/2020/02/11/wasm-synth/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://timdaub.github.io/2020/02/11/wasm-synth/&title=Building a web-ready synthesizer with WASM and C++" target="_blank" rel="noopener"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://timdaub.github.io/2020/02/11/wasm-synth/&title=Building a web-ready synthesizer with WASM and C++" target="_blank" rel="noopener"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://timdaub.github.io/2020/02/11/wasm-synth/&title=Building a web-ready synthesizer with WASM and C++" target="_blank" rel="noopener"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://timdaub.github.io/2020/02/11/wasm-synth/&title=Building a web-ready synthesizer with WASM and C++" target="_blank" rel="noopener"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://timdaub.github.io/2020/02/11/wasm-synth/&name=Building a web-ready synthesizer with WASM and C++&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=https://timdaub.github.io/2020/02/11/wasm-synth/&t=Building a web-ready synthesizer with WASM and C++" target="_blank" rel="noopener"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction"><span class="toc-number">1.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Theory"><span class="toc-number">2.</span> <span class="toc-text">Theory</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#The-Nyquist-Shannon-Sampling-Theorem"><span class="toc-number">2.1.</span> <span class="toc-text">The Nyquist-Shannon Sampling Theorem</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Frames-and-Ring-Buffers"><span class="toc-number">2.2.</span> <span class="toc-text">Frames and Ring Buffers</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Implementation"><span class="toc-number">3.</span> <span class="toc-text">Implementation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Using-the-AudioWorklet"><span class="toc-number">3.1.</span> <span class="toc-text">Using the AudioWorklet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#The-Math-of-Audio-Generation"><span class="toc-number">3.2.</span> <span class="toc-text">The Math of Audio Generation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Reverse-Engineering-the-Ableton-Live-Operator"><span class="toc-number">3.3.</span> <span class="toc-text">Reverse Engineering the Ableton Live Operator</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Working-with-WebAssembly-and-C"><span class="toc-number">3.4.</span> <span class="toc-text">Working with WebAssembly and C++</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lessons-Learned"><span class="toc-number">4.</span> <span class="toc-text">Lessons Learned</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Resources"><span class="toc-number">5.</span> <span class="toc-text">Resources</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Appendix"><span class="toc-number">6.</span> <span class="toc-text">Appendix</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#The-emscripten-Build-Pipeline"><span class="toc-number">6.1.</span> <span class="toc-text">The emscripten Build Pipeline</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Building a web-ready synthesizer with WASM and C++
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Tim DaubenschÃ¼tz</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2020-02-11T15:14:21.379Z" itemprop="datePublished">2020-02-11</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        
    </div>


      |
      <i class="fas fa-stopwatch"></i>
      33 minutes read
    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p><strong>TL;DR:</strong> I built a synthesizer for the web using C++ and WebAssembly. This
post outlines how I did it. Read on to learn more or check out the project
directly: <a href="https://github.com/TimDaub/wasm-synth" target="_blank" rel="noopener">[source]</a>
<a href="https://timdaub.github.io/wasm-synth/">[demo]</a></p>
<hr>
<p><a href="https://timdaub.github.io/wasm-synth/"><img src="/assets/images/wasm-synth.png" alt></a></p>
<h2 id="Introduction">Introduction</h2>
<p>In November 2019, I got a bit bored with my work in blockchain and
cryptocurrencies. After all, working in a field for 5 years non-stop is kinda
tiring as I started seeing reoccurring problems emerge. But I had started
taking piano lessons 2 years earlier, and so decided to take a look into a
completely different field for finding renewed inspiration. The field I decided
on was digital audio engineering. I planned to explore it for three months in
total to build a project of my liking.</p>
<p>I knew quite quickly what I wanted to build: A synthesizer. In C++!  I had just
finished some talks on WebAssembly, and so I was very curious to learn a new
language and apply it with WASM! The personal challenge that came with that was
less in learning a new programming language or setting up build-tools. Rather,
it was to understand the data structures and math that goes into generating
audio.</p>
<p>Speaking of math, I considered my self quite bad at it! After all, I never got
good grades in college or school. But that&#x2019;s exactly what lured me into the
challenge. Would I be able to build a proper product that applies to math?</p>
<p>Yes, my gut said. I think so, my brain. And, because I had learned from
attending chaos computer club events that many concepts could be learned quite
playfully through reverse engineering nerdy exploration, I decided to embark on
the journey. Almost four months later, I&#x2019;d now like to share my lessons in
this post.</p>
<h2 id="Theory">Theory</h2>
<p>I had never done anything in the field of music. And so when I started, I
really I almost did at zero. Hence, these first few sections outline some
basics of audio generation. A further section will then detail the
implementation.</p>
<h3 id="The-Nyquist-Shannon-Sampling-Theorem">The Nyquist-Shannon Sampling Theorem</h3>
<p>Sound is consumed over time. Regular instruments essentially emit sound waves
over time through e.g. resonance. This emission produces a time-continuous
(<em>&#x201C;analog&#x201D;</em>) signal. Meaning that for each point in time, the signal produces
a unique value in e.g. amplitude. As computers work with zeros and ones, this
property remains unfulfilled in the digital realm. In contrast, computers can
merely approximate analog values by sampling them into time-discreet values.
They&#x2019;re so good at approximating that the digital representation of
an analog signal virtually becomes indistinguishable to a user&#x2019;s ear. At least
as long as the sampling complies with some basic rules of signal processing.</p>
<p>A pretty fundamental principle in this regard is the <a href="https://en.wikipedia.org/wiki/Nyquist%E2%80%93Shannon_sampling_theorem" target="_blank" rel="noopener">Nyquist&#x2013;Shannon sampling
theorem</a>.
It states that, in order to capture all necessary information from a
continuous-time signal, a function <em>&#x201C;sampling&#x201D;</em> the signal needs to record data
at least at twice the rate of the original. Is this requirement unfulfilled,
then the resulting digital signal will contain an artifact called <em>&#x201C;Aliasing&#x201D;</em>,
distorting the familiarity of the original signal (<a href="https://en.wikipedia.org/wiki/File:Sawtooth-aliasingdemo.ogg" target="_blank" rel="noopener">An example of a sawtooth wave
aliasing</a>).</p>
<p>Though we&#x2019;re not planning to record analog signal to digital, we&#x2019;ll still
have to comply with this theorem, as synthesizing sound is nothing more than
filling a list with time-discreet values too. Practically, it may look
something like this:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// Simple pseudo code noise generator</span><br><span class="line"></span><br><span class="line">context = new AudioContext()</span><br><span class="line">samples = []</span><br><span class="line"></span><br><span class="line">for (i = 0; i &lt; context.sampleRate; i++) {</span><br><span class="line">  // Generate noise</span><br><span class="line">  samples.append(random.choice([0, 1]))</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// We&apos;ve generated enough samples for exactly 1 second.</span><br><span class="line">// The output will hence be 1 second of noise.</span><br><span class="line">context.play(samples)</span><br></pre></td></tr></table></figure>
<p>Here, we&#x2019;re initiating a new <code>AudioContext</code> object, get its sample rate and
generate enough samples to have the noise last for at least one second.
Admittedly, the Nyquist-Shannon theorem is less of a problem here, as the
<code>sampleRate</code> is likely to be set to a reasonable value by the <code>AudioContext</code>. But
assuming it was set to only 200 Hertz, outputting a piano&#x2019;s middle C (<a href="https://en.wikipedia.org/wiki/Piano_key_frequencies" target="_blank" rel="noopener">261.6256
Hertz</a>) would already
become difficult, as the required 261 repetitions per second to output middle C
simply wouldn&#x2019;t fit into the 200 repetitions per second of our sample rate.
Practically, what would happen is that our sampling algorithm would be
&#x201C;overtaken&#x201D; by middle C&#x2019;s frequency and hence output a shifted version. The
figure below nicely visualizes the effect, showing what happens if the sample
rate is gradually decreased from twice the original&#x2019;s frequency.</p>
<p><img src="/assets/images/nyquist.png" alt="Undersampling: The signal&apos;s frequency is increased while the sampling rate (dotted line) remains steady."></p>
<p>But assuming the correctness of our sample rate, there&#x2019;s another problem with
the above code. Imagine, we substituted the noise function with a nice-sounding
sine wave and then integrated and sold it as a hardware synthesizer.  When
pressing a key, the player would hear the respective tone for a second.
Pressing another key, they&#x2019;d hear another tone and so on. But since we built
our function to only generate static-length tones of a one-second length, it
wouldn&#x2019;t be much fun making music, as playing rhythmic patterns would be
impossible!</p>
<p><img src="/assets/images/frames.png" alt="Large buffer sizes can introduce latency for the user."></p>
<p>That&#x2019;s because music doesn&#x2019;t work on an absolute time scale, but on a relative
one. We&#x2019;d never say that a note &#x201C;lasts for one second&#x201D;. Rather we&#x2019;d say it
&#x201C;lasts for a quarter bar&#x201D; and, hence, call it a &#x201C;quarter note&#x201D;. To build a
software instrument, this means that we&#x2019;ll have to optimize for real-time
responsiveness and maximum expressiveness. For this, we&#x2019;ll need specific data
structures.</p>
<h3 id="Frames-and-Ring-Buffers">Frames and Ring Buffers</h3>
<p>As we&#x2019;ve seen in the previous code example, time-discrete audio data is sent to
the sound card as a list or buffer. I&#x2019;d argue, it&#x2019;s the most prevalent approach
when outputting audio. But as we&#x2019;ve just learned, that buffer&#x2019;s size determines
the responsiveness of our instrument. A concept that nicely dissolves this
problem is called <em>&#x201C;frames&#x201D;</em>. With the concept of <em>frames</em>, instead of sending
a fixed-length buffer of samples to the output device, we chunk it into smaller
<em>frames</em> and instead continuously send these.  In theory, we&#x2019;d ideally limit
the size of a frame to a single sample for maximum responsiveness, meaning we&#x2019;d
now be <em>&#x201C;streaming&#x201D;</em> our data. But given that timing is crucial too, we&#x2019;ll have
to come up with yet another strategy for sending just the right amount of data
in a given time frame. For this, we can use a different concept and data
structure called a <em>&#x201C;ring buffer&#x201D;</em>.</p>
<p><img src="/assets/images/ring-buffer.gif" alt="A ring buffer processing a keyboards&apos; inputs."></p>
<p>A ring buffer is a fixed-size list, managed by two distinct pointers.  One
writing values, the other &#x201C;chasing&#x201D; and consuming them. This allows a program
to continuously stream data, precisely at the speed of the chasing pointer.
Additionally, it allows providing developers with a <em>&#x201C;pull&#x201D;</em> rather than a
<em>&#x201C;push&#x201D;</em> API.  Now, instead of having to optimize their program to periodically
push new frames to the output device, a developer can simply use the callback
function of a ring buffer&#x2019;s writing pointer to be notified about a shortage of
fresh data.</p>
<p>But so much for theory. Let&#x2019;s explore how these concepts are implemented in
practice.</p>
<h2 id="Implementation">Implementation</h2>
<p>As we&#x2019;ve discussed the most important theoretical concepts in the previous
section, we can now move into the implementation phase. Specifically, we&#x2019;ll
highlight three distinct issues that had to be overcome.</p>
<h3 id="Using-the-AudioWorklet">Using the <code>AudioWorklet</code></h3>
<p>Today, there&#x2019;s sadly no cross-browser API implementing all the above concepts
properly. This requires <em>some</em> improvisation when trying to build a synthesizer
for the web. Naively, one might think that <code>setTimeout</code> and <code>setInterval</code> allow
to easily implement a ring buffer. However, <a href="https://stackoverflow.com/a/29972322/1263876" target="_blank" rel="noopener">their accuracy can&#x2019;t be
trusted</a><sup id="a1"><a href="#f1">1</a></sup>.  Alternatively, there&#x2019;s the web audio API&#x2019;s
<a href="https://developer.mozilla.org/en-US/docs/Web/API/ScriptProcessorNode" target="_blank" rel="noopener"><code>ScriptProcessorNode</code></a>.
And while it allows hooking into the output device&#x2019;s streaming process, it
still requires a <em>push</em> approach, as inserting just the right amount of samples
per second into the output stream is kept to the developer. Additionally,
<code>ScriptProcessorNode</code> has been deprecated since 2014! Without any reasonable
cross-browser compatible alternative available&#x2026; Yikes!</p>
<p>This deprecation, of course, didn&#x2019;t come without
<a href="https://blog.mecheye.net/2017/09/i-dont-know-who-the-web-audio-api-is-designed-for/" target="_blank" rel="noopener">complaints</a>.
Luckily, it happened a few years ago already. Since then, the browser vendors
have worked on implementing an alternative for <code>ScriptProcessorNode</code>, the
<a href="https://developer.mozilla.org/en-US/docs/Web/API/AudioWorklet" target="_blank" rel="noopener"><code>AudioWorklet</code></a>.
In essence, it&#x2019;s what I&#x2019;ve described previously as a ring buffer but spawned in
a separate thread (hence a
<a href="https://developer.mozilla.org/en-US/docs/Web/API/Worklet" target="_blank" rel="noopener"><code>Worklet</code></a>) to
guarantee lag-free audio processing.</p>
<p>It&#x2019;s pretty straight-forward to convert our static noise example from above
into an <code>AudioWorklet</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NoiseWorklet</span> <span class="keyword">extends</span> <span class="title">AudioWorkletProcessor</span> </span>{</span><br><span class="line">  process(inputs, outputs, parameters) {</span><br><span class="line">    <span class="keyword">const</span> outputChannel = outputs[<span class="number">0</span>][<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; outputChannel.length; i++) {</span><br><span class="line">      outputChannel[i] = <span class="built_in">Math</span>.round(<span class="built_in">Math</span>.random());</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">registerProcessor(<span class="string">&quot;NoiseWorklet&quot;</span>, SynthWorklet);</span><br></pre></td></tr></table></figure>
<p>Here, we simply extend our class with the <code>AudioWorkletProcessor</code> and implement
the mandatory <code>process(inputs, output, parameter)</code> function. In <code>process</code>, we
can both access all currently available audio <code>inputs</code> and <code>outputs</code> and
<em>process</em> them. We won&#x2019;t have to add them in the <code>return</code>, as they&#x2019;re
manipulated by reference. Conveniently, <code>process</code> is called for us every time
the output device needs more data, so to say every time the ring buffer&#x2019;s read
pointer runs out of data to chase.</p>
<p><img src="/assets/images/audioworklet-compatibility.png" alt="The &apos;s current browser compatibility (early 2020)."></p>
<p>An important detail to consider is that, at the time of writing, the
<code>AudioWorklet</code> API is, sadly, only supported by a handful of browsers. A
<a href="https://github.com/GoogleChromeLabs/audioworklet-polyfill" target="_blank" rel="noopener">polyfill</a> is
available. As it&#x2019;s master branch and npm release were buggy though, I had to
submit a
<a href="https://github.com/GoogleChromeLabs/audioworklet-polyfill/pull/21" target="_blank" rel="noopener">PR</a> first
before being able to use it. Thanks, Google Chrome team&#x2026;</p>
<p>But ultimately, I got everything working cross-browser and was able to move on
to more interesting things!</p>
<h3 id="The-Math-of-Audio-Generation">The Math of Audio Generation</h3>
<p>One of the most daunting tasks of the project was having to deal with the math
to generate audio. After all, the last time I had dealt with frequencies was
back in high school physics class and more recently in some computer science
lectures.  In all honesty, though, I had to start from scratch as I had
forgotten almost everything!</p>
<p>So in this section, I&#x2019;ll establish a particular formula in great detail as that
was what necessary for me to come up with a functioning product. There was
other, maybe even fancier, math involved in other components too. But
explaining it too would increase this post&#x2019;s scope significantly. I might write
it down in a follow-up. For now, let&#x2019;s focus on the basics!</p>
<p>I started by <a href="https://hackmd.io/fR86Sw1nSFGdeFmgirt7qw#Math" target="_blank" rel="noopener">playing
around</a> with sine waves in
<a href="http://jsbin.com" target="_blank" rel="noopener">jsbin.com</a>. Quickly, I realized that I had to go back even further,
e.g. by looking up the definition of a frequency and by researching the period
length of $sin(x)$. Spoiler: It&#x2019;s $2\pi$.</p>
<iframe src="https://www.desmos.com/calculator/pi8zdfqkbp?embed" style="border:
1px solid #ccc" frameborder="0"></iframe>
<p>The first mathematical problem I encountered was when I tried to dynamically
render a tone for a given MIDI key. MIDI keys are tuned by assigning each note
to an ascending integer. This integer can then be run through a formula to
receive the respective frequency in Hertz of a note:</p>
<p>$$
f(n) = 2^{\frac{n-69}{12}} \times 440 ,\text{Hz},
$$</p>
<p>So can there be a formula to produce samples given a MIDI key number, I asked
myself. And even though I was a bit overwhelmed after my first mathematical
research, I eventually, got the hang of it and came up with something. Given a
sample rate $\sigma$ and a <a href="https://en.wikipedia.org/wiki/A440_(pitch_standard)" target="_blank" rel="noopener">440 Hertz
pitch</a>, there&#x2019;s a function
$s$ for approximating a sine wave for an $n^{th}$ MIDI key at a time interval
$t_n$:</p>
<p>$$
s(t_n) = sin(\frac{2\pi t_n \times 2^{\frac{n - 69}{12}} \times 440}{\sigma})
$$</p>
<p>&#x1F631; Looks complicated! Let&#x2019;s take a closer look to see whether we can simplify.
First off, I think it&#x2019;s important to know the intention behind designing this
function. As I said, it&#x2019;s purpose is to generate sample values given a
<a href="https://en.wikipedia.org/wiki/MIDI" target="_blank" rel="noopener">MIDI</a> key number. We just learned that
there&#x2019;s a formula to generate a frequency value from a MIDI key index. And in
fact, we can see that $f$ is contained in the divisor of $s$</p>
<p>But now, the question is how we can render a sine wave with a specific
frequency?  Well, we already know that the length of one $sin(x)$ period is
$2\pi$. From math class, we might also remember that we can stretch and
compress the period of $sin(x)$ by multiplying $x$ by a factor $\gamma$.  This
means, that we can define the period length $p$ of $g(x) = sin(\gamma x)$ by
finding the relation between $\gamma$ and $2\pi$:</p>
<p>$$
p = \frac{2\pi}{| \gamma |}
$$</p>
<p>This already gives us some information on how to produce a number of samples
for a sine wave with a given frequency. Let&#x2019;s say we wanted to produce a 1
Hertz sine wave at a sample rate of 48 kHz for 1 second<sup id="a2"><a href="#f2">2</a></sup>. Well, then now we&#x2019;ll somehow have to generate 48000
samples from $sin(\gamma x)$.</p>
<p><img src="/assets/images/chunked-sinus-inverted.png" alt="A visual example of chunking a sinus function into tiny sampling-rate-sized bits."></p>
<p>Two approaches come to mind: Either stretch the period length of $g$ so that we
can simply input integers between $0$ and $48000$ <em>or</em> shrink $x$ relatively
such that that when we&#x2019;re closing in on $48000$ samples generated we also reach
$x = 2\pi$ on the x-axis.</p>
<p>As we&#x2019;ve already defined our period length formula $p$, let&#x2019;s go for the former
approach. Meaning that if we want our period length to be $p = 48000$, we can
shuffle $p = \frac{2\pi}{| \gamma |}$ to calculate $\gamma$:</p>
<p>$$
\gamma =\frac{\pi}{24000} = \frac{2\pi}{48000}
$$</p>
<p>More generally speaking, for a sample rate $\sigma$, we can now define a
function $g$ to generate samples like this:</p>
<p>$$
\begin{aligned}
g: \quad
&amp; [0, \sigma] \to \N\
&amp; x \mapsto sin(\frac{2\pi x}{\sigma})
\end{aligned}
$$</p>
<p>Generating an arbitrary frequency is now possible too! Say we wanted our sine
wave to cycle 10 times per second more, we&#x2019;d simply had to adjust our period
length by a factor of ten $\gamma = \frac{2\pi \times 10}{48000}$ to receive a
frequency at 10 Hertz.</p>
<p>$$
s(t_n) = sin(\frac{2\pi t_n \times 10}{\sigma})
$$</p>
<p>In fact, we can just replace this factor by our
MIDI-key-to-frequency function $f$:</p>
<p>$$
s(t_n) = sin(\frac{2\pi t_n \times 2^{\frac{n - 69}{12}} \times 440}{\sigma})
$$</p>
<p>Et voila, we just created a function that can produce samples at an arbitrary
sample rate $\sigma$ from a MIDI key number $n$ &#x1F389;
And since I now had passed the local mathematical insecurity hump, I ventured
ahead trying to solve more elaborate problems!</p>
<h3 id="Reverse-Engineering-the-Ableton-Live-Operator">Reverse Engineering the Ableton Live Operator</h3>
<p>A software instrument I had always liked was Ableton Live&#x2019;s Operator.</p>
<p><img src="/assets/images/live-operator.png" alt="The Ableton Live 10 Operator user interface."></p>
<p>I had a very basic understanding of oscillators and signal theory from physics
and so the left side of the panel showing configuration options for the four
oscillators quickly made sense. Same was true of the interactive graph in the
middle. Likely, as I inferred its mechanics from the piano. It&#x2019;s hammering
system in particular.  Here, the player&#x2019;s keypress catapults an internal
hammer against a string. As the string is tightened to swing at a specific
frequency, it results in the player hearing a familiar sound. This already
defines some important characteristics of a player&#x2019;s interaction with a
key-based instrument:</p>
<ul>
<li>The velocity and pressure of a player&#x2019;s finger determine the force a hammer
is catapulted with, resulting in a respective amplitude of the string&#x2019;s
oscillation.</li>
<li>Additionally, increased pressure, resulting in greater amplitudes, results in
an increased time period a sound is perceived by the player.</li>
</ul>
<div class="owl-media owl-image owl-giphy"><img src="https://media.giphy.com/media/trWQWvzDRmFCE/giphy.gif"></div>
<p>To give the player additional control over the amount of time the string is
swinging, there&#x2019;s, however, another mechanism at work. The dampener, the
hammer&#x2019;s antagonist, is lifted from the string on a player&#x2019;s keypress to allow
a free-swinging string. Once the player releases the key though, the dampener
is released too, falling onto the string and dampening its amplitude. That,
in turn, alternates the perceived loudness and continuity of the sound.</p>
<p><img src="/assets/images/adsr.png" alt></p>
<p>These phases, a sound passes through its life cycle, are commonly referred to
as the <em>&#x201C;envelope&#x201D;</em> of a wave. The figure above differentiates four distinct
phases:</p>
<ul>
<li><em>&#x201C;Attack&#x201D;</em>: The initial phase a sound is created, the moment the player
presses a key. In a mechanical piano, this phase occurs on the impact of
a hammer and string. During this phase, a tone reaches its peak volume before
<em>decaying</em> into <em>sustain</em>.</li>
<li><em>&#x201C;Decay&#x201D;</em>: The second phase. The moment the key&#x2019;s hammer retraces from its
impact position, the decay phase initiates as the string&#x2019;s vibration softly
decays through physical friction.</li>
<li>&#x201C;<em>Sustain</em>&#x201D;: Initially, pressing the key also moved the dampener away from
the string. This allows the string to vibrate freely and the player to
perceive the tone as <em>sustaining</em>. The sustain phase ends with the player
<em>releasing</em> the key.</li>
<li><em>&#x201C;Release&#x201D;</em>: On the release of the key, the dampener travels down onto the
string softening the vibration&#x2019;s amplitude.</li>
</ul>
<p>And this is exactly what the interactive graph in Ableton Live&#x2019;s operator is
describing. Clicking one of the yellow rectangles, it allows the envelope
to be adjusted.</p>
<p>As I really liked the intuition it was provoking, I decided to look around for
a react.js implementation of the metaphor. And not before long, I found an
<a href="https://github.com/gerardabello/adsr-envelope-graph" target="_blank" rel="noopener">abandoned library</a> that
served parts of the use case. It correctly rendered the graph using a
dynamically generated SVG. It didn&#x2019;t allow interacting with the graph by
dragging though. So, I ended up modifying the library heavily and releasing it
openly as
<a href="https://github.com/TimDaub/react-envelope-graph" target="_blank" rel="noopener"><code>react-envelope-graph</code></a>.</p>
<p><img src="/assets/images/react-envelope-graph.gif" alt></p>
<p>Its implementation isn&#x2019;t particularly interesting. What&#x2019;s interesting is the
math that went into mapping the user interface values to actual timing values.
For example, Ableton Live&#x2019;s Operator allows the user to specify the exact
duration of a phase in (milli)seconds.</p>
<p><img src="/assets/images/exponential-adsr.gif" alt></p>
<p>But it doesn&#x2019;t add milliseconds linearly! Instead, it looks more like it adds
them at an exponential rate, as almost two thirds of the graph&#x2019;s draggable
distance is used for millisecond values and only the last third for values up
to 20 seconds.</p>
<p>I hadn&#x2019;t noticed this at all when I first started building
<code>react-envelope-graph</code> and so my implementation ended up outputting percentage
values for each phase.  Meaning that if a user decides to skip the attack
phase, the component returns $0.00$.  If they want half of it, it returns
$0.50$. And if they want a phase at full capacity, the component returns
$1.00$.</p>
<p>So naturally, when I discovered that Ableton Live used some sort of exponential
mapping, I started to look for a mathematical construct I could apply.
Essentially, what I was looking for was a function that takes inputs between $0
\le x \le 1$ and yields another value that is between $0$ and a maximum value
$\mu$ in seconds.</p>
<p>From intuition, I started to experiment with logarithmic and exponent
functions.  From math class, I still remembered that $e$ and $\ln$ cancel each
other out: $\ln e = 1$. The two are so-called inverse functions. This can be
easily seen by <em>playing them against each other</em> to create a linear slope in
the form of $(x) = x$. We define $p$ as:</p>
<p>$$
p(x) = e^{\ln x}
$$</p>
<iframe src="https://www.desmos.com/calculator/cdx7ihidzx?embed" style="border:
1px solid #ccc" frameborder="0"></iframe>
<p>This inversion property is useful when, for example, we want to shift the $y$
value of $e^x$ by a constant at the point of $x = 1$. While in its pure form,
it&#x2019;s <a href="https://en.wikipedia.org/wiki/E_(mathematical_constant)" target="_blank" rel="noopener">Euler&#x2019;s number</a>,
it can be adjusted towards the desired value by multiplying it by $\ln \mu$.
Applying this, we end up with a <a href="https://www.desmos.com/calculator/lf3fxzlujc" target="_blank" rel="noopener">function
$p&#x2019;$</a> whose $y$ value at $x=1$
can be adjusted using $\mu$:</p>
<p>$$
\begin{aligned}
p&#x2019;: \quad
&amp; [1, \mu] \to \N\
&amp; x \mapsto e^{x \ln \mu}
\end{aligned}
$$</p>
<p><img src="/assets/images/desmos-adjustable-exp.gif" alt></p>
<p>And indeed, that&#x2019;s really all we need. For the attack phase, for example, we&#x2019;d
set $\mu = 60000$ and can hence now input $0 \le x \le 1$ values that map a
duration on an exponential slope between 0 and 60000 milliseconds.</p>
<h3 id="Working-with-WebAssembly-and-C">Working with WebAssembly and C++</h3>
<p>Turns out, the easiest part in all of this was building it with WebAssembly and
C++. Yes, being a JavaScript developer, C++ looked really foreign at first and
I was scared of pointers and references. But, overall, it wasn&#x2019;t completely new
territory for me as I understood most low-level concepts from previous
projects. To kickstart development, I bought &#x201C;Accelerated C++&#x201D; by Andrew Koenig
and Barbara E. Moo. I read parts of it but then dove full into coding.</p>
<p>The same goes for emscripten and WebAssembly. There are a few gotchas, and I&#x2019;m
writing about one particular in the Appendix of this post, but overall
WebAssembly&#x2019;s tooling is already surprisingly usable and easily integrated into
a standard front end build pipeline.</p>
<p>I had initially decided on C++ and WASM for the performance boost I was promised.
Ultimately though, I really enjoyed having to separate my code base as it led
to a very loose coupling and nice modularization. Not only did I write a
fully-fledged audio library in C++ through this, it&#x2019;s now also portable to
anywhere WebAssembly runs! That&#x2019;s a beautiful thing!</p>
<h2 id="Lessons-Learned">Lessons Learned</h2>
<p>WASM Synth turned out to be a great learning experience. Working in the same
field for many months or years, it&#x2019;s easy to forget how amazing the brain&#x2019;s
capability of learning new things is. In November, after having worked on smart
contracts and decentralized apps for more than a year, I wasn&#x2019;t much confident
anymore in cutting my teeth at math.  But, as most things we use in our
day-to-day, they&#x2019;re simply just made by other humans. Meaning, their complexity
is usually limited and definitely manageable, given enough time and intrinsic
motivation.</p>
<p>The math involved, some of which I didn&#x2019;t outline in this post, really put me
out of my comfort zone. Ultimately, it opened up a new way of looking at it
though!  Today, I can just imagine what would have been if high-school Timmy
would have access to such amazing interactive mathematical tools like
<a href="http://desmos.com" target="_blank" rel="noopener">desmos.com</a>. I&#x2019;ve decided to commit myself more to math. I want to use it more
mindfully and formally in my projects. And I want to face it head-on and not try
to avoid it with the tricks of a computer scientist!</p>
<p>My overall thesis that many concepts can be mastered playfully by reverse
engineering their core problems once again proved to be true! &#x201C;Die kochen auch
nur mit Wasser!&#x201D; (Engl. &#x201C;Everybody else is also just cooking with water&#x201D;), one
of my most favorite German idioms hence remains true too, but probably not
unchallenged for too long, as my next project is likely already around the
corner!</p>
<h2 id="Resources">Resources</h2>
<p>A list of resources I used:</p>
<ul>
<li>WebAssembly
<ul>
<li><a href="https://emscripten.org" target="_blank" rel="noopener">emscripten: A toolchain to compile C++ to WASM</a></li>
<li><a href="https://medium.com/@tdeniffel/pragmatic-compiling-from-c-to-webassembly-a-guide-a496cc5954b8" target="_blank" rel="noopener">Step by step guide on how to use emscripten</a></li>
<li><a href="https://marcoselvatici.github.io/WASM_tutorial/" target="_blank" rel="noopener">Tutorial on how to manage memory in WebAssembly</a></li>
<li><a href="https://gist.github.com/automata/5832104" target="_blank" rel="noopener">Example on passing a <code>Float32Array</code> back and forth between JS and
C++</a></li>
<li><a href="https://www.leaningtech.com/cheerp/" target="_blank" rel="noopener">Emscripten alternative: cheerp</a></li>
<li><a href="https://github.com/charto/nbind" target="_blank" rel="noopener">Embind alternative: nbind</a></li>
<li><a href="https://emscripten.org/docs/compiling/Travis.html" target="_blank" rel="noopener">Continuous Deployment with emscripten on Travis CI</a></li>
</ul>
</li>
<li>Human-Audio Interaction
<ul>
<li><a href="https://www.audiocheck.net/soundtests_nonlinear.php" target="_blank" rel="noopener">The non-linearities of the Human Ear</a></li>
<li><a href="https://alemangui.github.io/blog//2015/12/26/ramp-to-value.html" target="_blank" rel="noopener">Explanation on why we hear a click when audio suddenly stops</a></li>
</ul>
</li>
<li>Audio Engineering:
<ul>
<li><a href="https://en.wikipedia.org/wiki/Piano_key_frequencies" target="_blank" rel="noopener">Piano Key Frequencies</a></li>
<li><a href="https://www.logicprohelp.com/forum/viewtopic.php?t=79553" target="_blank" rel="noopener">Nice forum post with links to audio engineering resources</a></li>
<li><a href="https://www.dsprelated.com" target="_blank" rel="noopener">Cool website for DSP nerds</a></li>
<li><a href="https://www.reddit.com/r/synthesizers/comments/544gfd/lets_say_i_want_to_design_and_build_synths_as_a/" target="_blank" rel="noopener">Career advice on how to become an audio engineer</a></li>
<li><a href="https://issuu.com/petergoldsborough/docs/thesis" target="_blank" rel="noopener">Thesis of someone that also built a synth in C++</a></li>
<li><a href="https://web.eecs.umich.edu/~fessler/course/100/l/l10-synth.pdf" target="_blank" rel="noopener">Advanced audio engineering theory slides</a></li>
<li><a href="https://www.midi.org/specifications/item/table-1-summary-of-midi-message" target="_blank" rel="noopener">MIDI protocol specification</a></li>
<li><a href="http://www.personal.kent.edu/~sbirch/Music_Production/MP-II/MIDI/midi_protocol.htm" target="_blank" rel="noopener">Another MIDI protocol specification</a></li>
<li><a href="https://stackoverflow.com/questions/43544357/how-to-connect-web-midi-api-to-native-application-like-ableton-live" target="_blank" rel="noopener">Web MIDI and Ableton Live API interaction</a></li>
<li><a href="https://codepen.io/peteranglea/pen/KZrGxo?editors=1111" target="_blank" rel="noopener">Demo of using the Web MIDI API in the browser</a></li>
<li><a href="http://www.martin-finke.de/blog/" target="_blank" rel="noopener">Most useful blog of all! Person that builds software synth in C++!</a></li>
<li><a href="http://teropa.info/blog/2016/08/04/sine-waves.html" target="_blank" rel="noopener">Step by step tutorial on how to build an oscillator in C++</a></li>
</ul>
</li>
<li>Math
<ul>
<li><a href="https://www.sparknotes.com/math/trigonometry/graphs/section4/" target="_blank" rel="noopener">Simple trigonometry explanation</a></li>
<li><a href="https://stackoverflow.com/questions/1073606/is-there-a-one-line-function-that-generates-a-triangle-wave/1073634#1073634" target="_blank" rel="noopener">Some waveform formulas</a></li>
<li><a href="https://docs.cycling74.com/max5/tutorials/msp-tut/mspdigitalaudio.html" target="_blank" rel="noopener">Nice introduction resource on how audio works from a mathematical perspective</a></li>
<li><a href="http://www-math.bgsu.edu/~zirbel/sound/Trigonometric%20functions%20and%20sound.pdf" target="_blank" rel="noopener">Really helpful resource on how to render chords properly</a></li>
<li><a href="https://en.wikipedia.org/wiki/Damped_sine_wave" target="_blank" rel="noopener">Wikipedia article on how to dampen a sin wave (very useful!)</a></li>
<li><a href="https://dsp.stackexchange.com/questions/2555/help-with-equations-for-exponential-adsr-envelope" target="_blank" rel="noopener">ADSR models</a></li>
<li><a href="https://www.desmos.com/calculator/nduy9l2pez" target="_blank" rel="noopener">ADSR model used by WASM Synth</a></li>
</ul>
</li>
<li>Music Theory:
<ul>
<li><a href="https://de.m.wikipedia.org/wiki/Gleichstufige_Stimmung" target="_blank" rel="noopener">Wikipedia: Gleichstufige Stimmung</a></li>
<li><a href="https://electronics.stackexchange.com/questions/32310/what-exactly-are-harmonics-and-how-do-they-appear" target="_blank" rel="noopener">What exactly are harmonics and where do they appear?</a></li>
</ul>
</li>
<li>Web Audio API:
<ul>
<li><a href="https://github.com/cwilso/midi-synth" target="_blank" rel="noopener">MIDI synth project</a></li>
<li><a href="https://webaudiodemos.appspot.com/slides/index.html#/" target="_blank" rel="noopener">Slides about the Web Audio API</a></li>
<li><a href="https://www.webaudiomodules.org/" target="_blank" rel="noopener">Collection of Web Audio Synths</a></li>
<li><a href="https://github.com/audiojs/web-audio-api/blob/f80aaa6bfaaa41d418f3316d767ac0f88f6bc4e0/lib/AudioParam.js#L172" target="_blank" rel="noopener">WebAudio API implementation for Node.js detailing gain up and down ramping</a></li>
<li><a href="http://teropa.info/blog/2016/08/30/amplitude-and-loudness.html" target="_blank" rel="noopener">Explanation on the relationship of Gain and Decibels in the WebAudio API</a></li>
<li><a href="https://blog.mecheye.net/2017/09/i-dont-know-who-the-web-audio-api-is-designed-for/" target="_blank" rel="noopener">Person complaining about the Web Audio API</a></li>
<li><a href="https://github.com/chrisguttandin/standardized-audio-context" target="_blank" rel="noopener">Super useful polyfill for the Web Audio API</a></li>
</ul>
</li>
<li>Misc:
<ul>
<li><a href="https://www.szynalski.com/tone-generator/" target="_blank" rel="noopener">An online sound generator</a></li>
<li><a href="https://stackoverflow.com/questions/21238543/c-al-altypes-h-no-such-file-or-directory" target="_blank" rel="noopener">Explanation on how to output a sin wave in OpenAL</a></li>
</ul>
</li>
</ul>
<h2 id="Appendix">Appendix</h2>
<h3 id="The-emscripten-Build-Pipeline">The <code>emscripten</code> Build Pipeline</h3>
<p>A question I had before working with emscripten was: &#x201C;How do I integrate
WebAssembly into my regular web app build, without bloating it too much?&#x201D;. To
put things into perspective: I had just recently switched from Webpack to
rollup.js as I was sick of spending hours setting up Webpack with its ten
thousand magic configuration options.</p>
<p>To my surprise, however, neither framework has good defaults for handling
WebAssembly yet. Especially, not if it&#x2019;s generated with emscripten and is
bigger than the <a href="https://developers.google.com/web/updates/2018/04/loading-wasm" target="_blank" rel="noopener">4KB <code>.wasm</code> file size
limit</a>. But there
were other problems too:</p>
<ul>
<li>rollup.js bundles a JavaScript file that includes react.js and boots the app</li>
<li>emscripten generates a <code>.wasm</code> and a <code>.js</code> file. The <code>.wasm</code> file basically
contains all C++ source as WebAssembly instructions. The <code>.js</code> file acts as the
glue between WebAssembly and JavaScript.
<ul>
<li>In some cases, there&#x2019;s this 4KB size limit on loading <code>.wasm</code> files</li>
<li>The emscripten <code>.js</code> glue code is super useful. For practical reasons,
it&#x2019;s recommended always including it into the page</li>
</ul>
</li>
<li>The <code>AudioWorklet</code> is supposed to be included into the page by using <code>new AudioContext().addModule(&lt;path&gt;)</code>
<ul>
<li>It has its own global scope. But emscripten&#x2019;s glue code relies on the
global scope too (<code>Module</code> object)</li>
</ul>
</li>
<li>Rollup.js doesn&#x2019;t have good defaults or plugins for bundling
emscripten-generated <code>.wasm</code> code.</li>
</ul>
<p>In the end, this led me to build a custom pipeline to bundle emscripten builds
every time my source changed. But before I explain how, let&#x2019;s take a step back
to understand how emscripten&#x2019;s compilation works.</p>
<p>On installation, emscripten exports a command-line utility called <code>emcc</code> into
the shell. To demonstrate its capabilities, let&#x2019;s try compiling the <code>Hello World</code> example from the beginning of the post:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;emscripten/bind.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> emscripten;</span><br><span class="line"></span><br><span class="line"><span class="built_in">std</span>::<span class="function"><span class="built_in">string</span> <span class="title">hello</span><span class="params">()</span> </span>{</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;hello world&quot;</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// <span class="doctag">NOTE:</span> Using embind, we can define `hello`&apos;s external name</span></span><br><span class="line">EMSCRIPTEN_BINDINGS(my_module) {</span><br><span class="line">  function(<span class="string">&quot;hello&quot;</span>, &amp;hello);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>To make it executable by a browser, we&#x2019;ll use <code>emcc</code> to compile it to a <code>.wasm</code>
and a <code>.js</code> file.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ emcc main.cc --<span class="built_in">bind</span> -WASM=1 -o main.js</span><br></pre></td></tr></table></figure>
<p><code>emcc</code> here simply compiles all functions contained in <code>main.cc</code> into a
<code>main.wasm</code> file. In addition, it also generates this glue code (<code>main.js</code>)
using
<a href="https://emscripten.org/docs/porting/connecting_cpp_and_javascript/embind.html" target="_blank" rel="noopener">Embind</a>.
It allows us to invoke functions, originally written in C++, directly from
within JavaScript as if they were just regular classes. So to make emscripten&#x2019;s
outputs work properly, we&#x2019;ll have to include the <code>.js</code> into the page. On
initialization of the page, it will load the <code>.wasm</code> file asynchronously, skip
the 4KB <code>.wasm</code> file size limit and make all our C++ classes available as
native JS classes.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;wasm/main.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">      Module.onRuntimeInitialized = <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>{</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(Module.hello());</span></span><br><span class="line">      }</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>So far so good. But, like I&#x2019;ve mentioned previously one of the problems now is that
the <code>AudioWorklet</code>, being spawned in a separate thread with a separate global
scope, won&#x2019;t be aware of emscripten&#x2019;s <code>window.Module</code>. So how do we export code
from within a Worklet?</p>
<p>After spending quite some time researching that question, I discovered that the
Google Chrome Labs team
<a href="https://github.com/GoogleChromeLabs/web-audio-samples/blob/master/audio-worklet/design-pattern/wasm/index.html" target="_blank" rel="noopener">recommends</a>
transpiling all JavaScript source into <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Modules" target="_blank" rel="noopener">native
modules</a>
and then simply use ES6&#x2019;s <code>import from</code> syntax. Well, turns out the JS modules
syntax <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Modules" target="_blank" rel="noopener">isn&#x2019;t widely supported
yet</a>,
particularly not in <code>Workers</code>, let alone <code>Worklets</code>&#x2026;</p>
<p><img src="/assets/images/import-support.png" alt></p>
<p>But luckily, after banging my head another few days against JS modules and
other fancy new front end frameworks, I found a surprisingly simple trick, that
I&#x2019;m now actually quite proud of. I&#x2019;ve not seen it being used elsewhere so far!</p>
<p>I reduce emscripten&#x2019;s outputs to a single <code>.js</code> file that contains the <code>.wasm</code>
as base64 string using it&#x2019;s <code>-s SINGLE_FILE=1</code> option. As we need emscripten&#x2019;s
<code>.js</code> file to define <code>window.Module</code> in the <code>AudioWorklet</code>&apos;s global scope, I
then simply append the emscripten JavaScript file with the <code>AudioWorklet</code>&#x2019;
JavaScript file to make them configure the same global scope. This allows me to
execute WebAssembly from within a Worklet without using the badly supported
<code>import from</code> syntax. Ultimately, I ended up with the following bash script (or
on
<a href="https://github.com/TimDaub/wasm-synth/blob/master/scripts/build.sh" target="_blank" rel="noopener">GitHub</a>):</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line"></span><br><span class="line">DIR=<span class="string">&quot;.wasm&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># <span class="doctag">NOTE:</span> Generates the .wasm directory if it doesn&apos;t exist yet.</span></span><br><span class="line"><span class="keyword">if</span> [ ! -d <span class="variable">$DIR</span> ]; <span class="keyword">then</span></span><br><span class="line">  mkdir <span class="variable">$DIR</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># NOTE `-std`: To use modern c++11 features like std::tuple and std::vector,</span></span><br><span class="line"><span class="comment"># we need to enable C++ 11 by passing the parameter to gcc through emcc.</span></span><br><span class="line">emcc src/cpp/*.cc \</span><br><span class="line">  -std=c++11 \</span><br><span class="line">  -O1 \</span><br><span class="line">  -s WASM=1 \</span><br><span class="line">  -s ALLOW_MEMORY_GROWTH=1 \</span><br><span class="line">  -s BINARYEN_ASYNC_COMPILATION=0 \</span><br><span class="line">  -s SINGLE_FILE=1 \</span><br><span class="line">  -s MODULARIZE=1 \</span><br><span class="line">  --<span class="built_in">bind</span> \</span><br><span class="line">  -o <span class="variable">$DIR</span>/main.js</span><br><span class="line"></span><br><span class="line"><span class="comment"># <span class="doctag">NOTE:</span> We concat the emscripten generated js and wasm file with the worklet</span></span><br><span class="line"><span class="comment"># such that we don&apos;t have to import it later as an es6 module. This</span></span><br><span class="line"><span class="comment"># achieves better cross-browser compatibility.</span></span><br><span class="line">cat <span class="variable">$DIR</span>/main.js src/js/worklets/synth.js &gt; public/worklets/synth.js</span><br></pre></td></tr></table></figure>
<p>To update the page every time the source changed, I additionally used
<a href="https://www.npmjs.com/package/npm-watch" target="_blank" rel="noopener"><code>npm-watch</code></a> to re-run the routine
each time file changes occur.</p>
<hr>
<p><em>Footnotes:</em></p>
<p><small><a name="f1">1</a>: I couldn&#x2019;t find a specific reason for why
<code>setTimeout</code> and <code>setInterval</code> are inaccurate. I&#x2019;m suspecting it has to do with
JavaScript&#x2019;s event loop.  Please let me know if you have more details.
<a href="#a1">&#x2191;</a></small></p>
<p><small><a name="f2">2</a>: 48 kHz is the standard audio sampling rate used by
professional digital video equipment <a href="#a2">&#x2191;</a></small></p>
<!-- flag of hidden posts -->
  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/projects/">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction"><span class="toc-number">1.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Theory"><span class="toc-number">2.</span> <span class="toc-text">Theory</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#The-Nyquist-Shannon-Sampling-Theorem"><span class="toc-number">2.1.</span> <span class="toc-text">The Nyquist-Shannon Sampling Theorem</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Frames-and-Ring-Buffers"><span class="toc-number">2.2.</span> <span class="toc-text">Frames and Ring Buffers</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Implementation"><span class="toc-number">3.</span> <span class="toc-text">Implementation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Using-the-AudioWorklet"><span class="toc-number">3.1.</span> <span class="toc-text">Using the AudioWorklet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#The-Math-of-Audio-Generation"><span class="toc-number">3.2.</span> <span class="toc-text">The Math of Audio Generation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Reverse-Engineering-the-Ableton-Live-Operator"><span class="toc-number">3.3.</span> <span class="toc-text">Reverse Engineering the Ableton Live Operator</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Working-with-WebAssembly-and-C"><span class="toc-number">3.4.</span> <span class="toc-text">Working with WebAssembly and C++</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lessons-Learned"><span class="toc-number">4.</span> <span class="toc-text">Lessons Learned</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Resources"><span class="toc-number">5.</span> <span class="toc-text">Resources</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Appendix"><span class="toc-number">6.</span> <span class="toc-text">Appendix</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#The-emscripten-Build-Pipeline"><span class="toc-number">6.1.</span> <span class="toc-text">The emscripten Build Pipeline</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://timdaub.github.io/2020/02/11/wasm-synth/" target="_blank" rel="noopener"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://timdaub.github.io/2020/02/11/wasm-synth/&text=Building a web-ready synthesizer with WASM and C++" target="_blank" rel="noopener"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://timdaub.github.io/2020/02/11/wasm-synth/&title=Building a web-ready synthesizer with WASM and C++" target="_blank" rel="noopener"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://timdaub.github.io/2020/02/11/wasm-synth/&is_video=false&description=Building a web-ready synthesizer with WASM and C++" target="_blank" rel="noopener"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Building a web-ready synthesizer with WASM and C++&body=Check out this article: https://timdaub.github.io/2020/02/11/wasm-synth/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://timdaub.github.io/2020/02/11/wasm-synth/&title=Building a web-ready synthesizer with WASM and C++" target="_blank" rel="noopener"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://timdaub.github.io/2020/02/11/wasm-synth/&title=Building a web-ready synthesizer with WASM and C++" target="_blank" rel="noopener"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://timdaub.github.io/2020/02/11/wasm-synth/&title=Building a web-ready synthesizer with WASM and C++" target="_blank" rel="noopener"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://timdaub.github.io/2020/02/11/wasm-synth/&title=Building a web-ready synthesizer with WASM and C++" target="_blank" rel="noopener"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://timdaub.github.io/2020/02/11/wasm-synth/&name=Building a web-ready synthesizer with WASM and C++&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=https://timdaub.github.io/2020/02/11/wasm-synth/&t=Building a web-ready synthesizer with WASM and C++" target="_blank" rel="noopener"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2020 Tim DaubenschÃ¼tz
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/projects/">Projects</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments --><!-- hexo-inject:begin --><!-- hexo-inject:end -->


</body>
</html>
